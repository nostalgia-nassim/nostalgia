<!DOCTYPE html>
<html lang="en">
<head>
<meta name="robots" content="noindex, nofollow">
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#D4A017">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="HA-NASSIM">
<title>HA-NASSIM ♔</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&family=Playfair+Display:ital,wght@0,700;0,900;1,700&display=swap');

:root{
  --theme-hue:43;
  --theme-sat:82%;
  --bg-main:#000;
  --bg-secondary:#080600;
  --bg-card:rgba(10,9,6,0.92);
  --text-primary:#fff;
  --text-secondary:rgba(255,255,255,0.7);
  --text-muted:rgba(255,255,255,0.3);
  --border-primary:hsla(var(--theme-hue),var(--theme-sat),50%,0.13);
  --glow-1:hsla(var(--theme-hue),var(--theme-sat),50%,0.07);
  --glow-2:hsla(var(--theme-hue),var(--theme-sat),60%,0.04);
  --grid-line:hsla(var(--theme-hue),var(--theme-sat),50%,0.025);
  --t:hsl(var(--theme-hue),var(--theme-sat),50%);
  --t55:hsl(var(--theme-hue),var(--theme-sat),55%);
  --t60:hsl(var(--theme-hue),var(--theme-sat),60%);
  --t65:hsl(var(--theme-hue),var(--theme-sat),65%);
  --t03:hsla(var(--theme-hue),var(--theme-sat),50%,0.03);
  --t06:hsla(var(--theme-hue),var(--theme-sat),50%,0.06);
  --t08:hsla(var(--theme-hue),var(--theme-sat),50%,0.08);
  --t10:hsla(var(--theme-hue),var(--theme-sat),50%,0.10);
  --t15:hsla(var(--theme-hue),var(--theme-sat),50%,0.15);
  --t20:hsla(var(--theme-hue),var(--theme-sat),50%,0.20);
  --t25:hsla(var(--theme-hue),var(--theme-sat),50%,0.25);
  --t30:hsla(var(--theme-hue),var(--theme-sat),50%,0.30);
  --t40:hsla(var(--theme-hue),var(--theme-sat),50%,0.40);
  --t50:hsla(var(--theme-hue),var(--theme-sat),50%,0.50);
  --t60a:hsla(var(--theme-hue),var(--theme-sat),50%,0.60);
  --t70:hsla(var(--theme-hue),var(--theme-sat),50%,0.70);
  --t80:hsla(var(--theme-hue),var(--theme-sat),50%,0.80);
  --t90:hsla(var(--theme-hue),var(--theme-sat),50%,0.90);
}

body.light-mode{
  --bg-main:#f5f2eb;--bg-secondary:#edeae0;
  --bg-card:rgba(255,253,248,0.97);
  --text-primary:#0a0a0a;--text-secondary:rgba(0,0,0,0.7);--text-muted:rgba(0,0,0,0.4);
  --border-primary:var(--t15);--glow-1:var(--t08);--glow-2:hsla(var(--theme-hue),var(--theme-sat),60%,0.06);--grid-line:var(--t06);
  /* light overrides for hardcoded rgba-white values */
  --input-bg:rgba(0,0,0,0.03);
  --input-border:rgba(0,0,0,0.1);
  --subtle-bg:rgba(0,0,0,0.03);
  --subtle-border:rgba(0,0,0,0.09);
  --range-track:rgba(0,0,0,0.12);
  --hex-color:rgba(0,0,0,0.65);
  --toggle-bg:rgba(0,0,0,0.06);
  --toggle-knob:rgba(0,0,0,0.2);
  --toggle-txt:rgba(0,0,0,0.45);
  --mode-txt:rgba(0,0,0,0.45);
  --char-count:rgba(0,0,0,0.3);
  --code-bg:#f0f0f0;
  --code-color:#1a6b2a;
  --copy-all-color:rgba(0,0,0,0.4);
  --msg-chars-color:rgba(0,0,0,0.3);
  --swatch-border:rgba(0,0,0,0.1);
}
:root{
  --input-bg:rgba(255,255,255,0.03);
  --input-border:rgba(255,255,255,0.06);
  --subtle-bg:rgba(255,255,255,0.02);
  --subtle-border:rgba(255,255,255,0.06);
  --range-track:rgba(255,255,255,0.08);
  --hex-color:rgba(255,255,255,0.7);
  --toggle-bg:rgba(255,255,255,0.05);
  --toggle-knob:rgba(255,255,255,0.25);
  --toggle-txt:rgba(255,255,255,0.35);
  --mode-txt:rgba(255,255,255,0.35);
  --char-count:rgba(255,255,255,0.2);
  --code-bg:rgba(0,0,0,0.4);
  --code-color:rgba(180,230,180,0.9);
  --copy-all-color:rgba(255,255,255,0.3);
  --msg-chars-color:rgba(255,255,255,0.2);
  --swatch-border:rgba(255,255,255,0.06);
}

*{margin:0;padding:0;box-sizing:border-box;-webkit-user-select:none;user-select:none;}
html,body{width:100%;overflow-x:hidden;scroll-behavior:smooth;}
body{font-family:'Inter',sans-serif;background:var(--bg-main);color:var(--text-primary);-webkit-font-smoothing:antialiased;transition:background 0.5s,color 0.5s;}

.premium-bg{position:fixed;inset:0;z-index:-1;background:radial-gradient(ellipse at top,var(--bg-secondary) 0%,var(--bg-main) 60%);transition:background 0.5s;}
.premium-bg::before{content:'';position:absolute;inset:0;background:radial-gradient(circle at 25% 25%,var(--glow-1) 0%,transparent 45%),radial-gradient(circle at 75% 75%,var(--glow-2) 0%,transparent 45%);animation:bgPulse 18s ease-in-out infinite;}
.luxury-grid{position:fixed;inset:0;z-index:-1;background-image:linear-gradient(var(--grid-line) 1px,transparent 1px),linear-gradient(90deg,var(--grid-line) 1px,transparent 1px);background-size:80px 80px;transition:background-image 0.5s;}
.mouse-glow{position:fixed;inset:0;pointer-events:none;z-index:0;transition:background 0.2s;}

@keyframes bgPulse{0%,100%{opacity:1;}50%{opacity:0.4;}}
@keyframes fadeUp{from{opacity:0;transform:translateY(40px);}to{opacity:1;transform:translateY(0);}}
@keyframes shimmer{0%{background-position:200% center;}100%{background-position:-200% center;}}

.fade-up{animation:fadeUp 0.7s ease-out forwards;}

.title-glow{
  font-family:'Playfair Display',serif;font-size:clamp(2rem,6vw,3.5rem);font-weight:900;
  background-size:200% auto;-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;
  animation:shimmer 6s linear infinite;letter-spacing:0.05em;
}

.section-label{display:flex;align-items:center;gap:12px;margin-bottom:16px;}
.section-label::before,.section-label::after{content:'';height:1px;flex:1;background:linear-gradient(90deg,transparent,var(--t40));}
.section-label::after{background:linear-gradient(270deg,transparent,var(--t40));}
.section-label span{font-size:0.65rem;font-weight:700;letter-spacing:0.25em;color:var(--t55);text-transform:uppercase;white-space:nowrap;}

.glass-card{background:var(--bg-card);border:1px solid var(--border-primary);border-radius:2px;position:relative;overflow:hidden;transition:border-color 0.3s,background 0.5s;}
.glass-card:hover{border-color:var(--t25);}
.glass-card::before{content:'';position:absolute;top:0;left:0;right:0;height:1px;background:linear-gradient(90deg,transparent,var(--t40),transparent);}

.field-label{font-size:0.6rem;font-weight:700;letter-spacing:0.25em;color:var(--text-muted);text-transform:uppercase;margin-bottom:8px;display:block;}

textarea,input[type=text]{background:var(--input-bg);border:1px solid var(--input-border);color:var(--text-primary);font-family:'Inter',sans-serif;font-size:0.95rem;border-radius:2px;transition:border-color 0.2s,background 0.2s,color 0.5s;width:100%;padding:12px 14px;resize:none;}
textarea:focus,input[type=text]:focus{outline:none;border-color:var(--t40);background:var(--t03);}
textarea::placeholder,input[type=text]::placeholder{color:var(--text-muted);opacity:0.4;}

.pill-btn{background:var(--subtle-bg);border:1px solid var(--subtle-border);border-radius:2px;padding:6px 18px;color:var(--text-secondary);font-family:'Inter',sans-serif;font-size:0.75rem;font-weight:700;letter-spacing:0.1em;cursor:pointer;transition:all 0.2s;}
.pill-btn:hover{border-color:var(--t40);color:var(--text-primary);}
.pill-btn.active{background:var(--t10);border-color:var(--t60a);color:var(--t55);}

.color-row{display:flex;align-items:center;gap:10px;background:var(--subtle-bg);border:1px solid var(--subtle-border);border-radius:2px;padding:8px 12px;}
input[type=color]{width:32px;height:32px;border:none;border-radius:2px;cursor:pointer;background:none;padding:0;flex-shrink:0;}
.hex-field{background:none;border:none;color:var(--hex-color);font-family:'Inter',monospace;font-size:0.8rem;letter-spacing:0.1em;width:100%;text-align:right;}
.hex-field:focus{outline:none;color:var(--text-primary);}

.toggle-wrap{display:flex;align-items:center;gap:10px;cursor:pointer;padding:4px 0;}
.toggle{width:38px;height:20px;background:var(--toggle-bg);border:1px solid var(--subtle-border);border-radius:10px;position:relative;transition:all 0.3s;flex-shrink:0;}
.toggle.on{background:var(--t20);border-color:var(--t50);}
.toggle::after{content:'';position:absolute;width:14px;height:14px;background:var(--toggle-knob);border-radius:50%;top:2px;left:2px;transition:all 0.3s;}
.toggle.on::after{transform:translateX(18px);background:var(--t60);}
.toggle-text{font-size:0.7rem;color:var(--toggle-txt);letter-spacing:0.1em;}

.mode-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:8px;}
@media(min-width:500px){.mode-grid{grid-template-columns:repeat(4,1fr);}}

.mode-card{background:var(--subtle-bg);border:1px solid var(--subtle-border);border-radius:2px;padding:12px 8px;cursor:pointer;text-align:center;transition:all 0.2s;}
.mode-card:hover{border-color:var(--t30);}
.mode-card.active{background:var(--t08);border-color:var(--t50);}
.mode-icon{font-size:1.1rem;display:block;margin-bottom:4px;color:var(--text-secondary);}
.mode-text{font-size:0.6rem;font-weight:600;letter-spacing:0.1em;color:var(--mode-txt);text-transform:uppercase;}
.mode-card.active .mode-text{color:var(--t80);}

input[type=range]{-webkit-appearance:none;width:100%;height:2px;background:var(--range-track);border-radius:1px;outline:none;}
input[type=range]::-webkit-slider-thumb{-webkit-appearance:none;width:14px;height:14px;background:var(--t);border-radius:50%;cursor:pointer;}

.gen-btn{width:100%;background:var(--t08);border:1px solid var(--t30);border-radius:2px;padding:16px;color:var(--t90);font-family:'Inter',sans-serif;font-size:0.75rem;font-weight:800;letter-spacing:0.3em;text-transform:uppercase;cursor:pointer;transition:all 0.3s;position:relative;overflow:hidden;}
.gen-btn::before{content:'';position:absolute;inset:0;background:linear-gradient(135deg,var(--t15),var(--t10));opacity:0;transition:opacity 0.3s;}
.gen-btn:hover{border-color:var(--t70);color:var(--t65);}
.gen-btn:hover::before{opacity:1;}
.gen-btn:active{transform:scale(0.995);}

.grad-bar{height:3px;border-radius:1px;transition:background 0.4s;margin-bottom:20px;}

.preset-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:6px;margin-bottom:16px;}
@media(min-width:500px){.preset-grid{grid-template-columns:repeat(8,1fr);}}
.preset-swatch{height:28px;border-radius:2px;border:1px solid var(--swatch-border);cursor:pointer;transition:all 0.2s;}
.preset-swatch:hover{border-color:var(--t50);transform:scaleY(1.1);}

.preview-box{background:var(--subtle-bg);border:1px solid var(--subtle-border);border-radius:2px;padding:16px;min-height:50px;font-size:1rem;word-break:break-all;line-height:1.9;margin-bottom:12px;}

.msg-item{background:var(--subtle-bg);border:1px solid var(--subtle-border);border-radius:2px;padding:14px;margin-bottom:8px;transition:border-color 0.2s;}
.msg-item:hover{border-color:var(--t20);}
.msg-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;}
.msg-num{font-size:0.6rem;font-weight:700;letter-spacing:0.2em;color:var(--t60a);text-transform:uppercase;}
.msg-chars{font-size:0.6rem;color:var(--msg-chars-color);}
.msg-code{font-family:monospace;font-size:0.72rem;color:var(--code-color);word-break:break-all;line-height:1.7;background:var(--code-bg);padding:10px 12px;border-radius:2px;margin-bottom:8px;cursor:pointer;border:1px solid transparent;transition:border-color 0.2s;direction:ltr;text-align:left;}
.msg-code:hover{border-color:var(--t20);}

.copy-btn{background:var(--t06);border:1px solid var(--t20);border-radius:2px;padding:5px 14px;color:var(--t70);font-family:'Inter',sans-serif;font-size:0.65rem;font-weight:700;letter-spacing:0.1em;cursor:pointer;transition:all 0.2s;text-transform:uppercase;}
.copy-btn:hover{background:var(--t15);color:var(--t60);}
.copy-btn.done{color:rgba(74,222,128,0.8);border-color:rgba(74,222,128,0.3);background:rgba(74,222,128,0.06);}

.copy-all{width:100%;background:var(--subtle-bg);border:1px solid var(--subtle-border);border-radius:2px;padding:12px;color:var(--copy-all-color);font-family:'Inter',sans-serif;font-size:0.65rem;font-weight:700;letter-spacing:0.2em;cursor:pointer;transition:all 0.2s;text-transform:uppercase;margin-bottom:12px;}
.copy-all:hover{border-color:var(--t30);color:var(--t70);}

/* ══════════ HAMBURGER ══════════ */
#hamburgerBtn{
  position:fixed;top:18px;left:16px;z-index:1000;
  width:44px;height:44px;background:var(--bg-card);
  border:1px solid var(--border-primary);border-radius:12px;
  display:flex;flex-direction:column;align-items:center;justify-content:center;gap:5px;
  cursor:pointer;box-shadow:0 2px 20px rgba(0,0,0,0.5);
  transition:opacity 0.3s,transform 0.3s,border-color 0.4s;
}
#hamburgerBtn:hover{border-color:var(--t40);}
#hamburgerBtn.hidden{opacity:0;pointer-events:none;transform:translateX(-8px) scale(0.88);}
#hamburgerBtn span{display:block;width:17px;height:1.5px;background:var(--t55);border-radius:2px;transition:background 0.4s;}

/* ══════════ OVERLAY ══════════ */
#sidebarOverlay{
  position:fixed;inset:0;background:rgba(0,0,0,0.5);z-index:990;
  opacity:0;pointer-events:none;transition:opacity 0.38s;
  backdrop-filter:blur(4px);-webkit-backdrop-filter:blur(4px);
}
#sidebarOverlay.open{opacity:1;pointer-events:all;}

/* ══════════ SIDEBAR ══════════ */
#sidebarPanel{
  position:fixed;top:0;left:0;bottom:0;width:275px;
  background:linear-gradient(160deg,rgba(9,7,2,0.99) 0%,rgba(4,3,0,1) 100%);
  border-right:1px solid var(--border-primary);z-index:991;
  transform:translateX(-100%);
  transition:transform 0.42s cubic-bezier(0.4,0,0.2,1),border-color 0.5s;
  display:flex;flex-direction:column;
  box-shadow:8px 0 48px rgba(0,0,0,0.8);overflow:hidden;
}
body.light-mode #sidebarPanel{
  background:linear-gradient(160deg,rgba(252,249,242,0.99) 0%,rgba(246,242,232,1) 100%);
}
#sidebarPanel::after{
  content:'';position:absolute;top:0;right:0;width:1px;height:100%;
  background:linear-gradient(180deg,transparent 0%,var(--t30) 30%,var(--t15) 70%,transparent 100%);
  pointer-events:none;
}
#sidebarPanel.open{transform:translateX(0);}

/* Header */
.sb-header{padding:26px 20px 16px;border-bottom:1px solid rgba(255,255,255,0.05);}
body.light-mode .sb-header{border-bottom-color:rgba(0,0,0,0.07);}
.sb-logo{font-family:'Playfair Display',serif;font-size:1.05rem;font-weight:900;background:linear-gradient(135deg,#fbbf24 0%,#fff8e7 55%,#fbbf24 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;letter-spacing:0.1em;}
.sb-sub{font-size:0.48rem;font-weight:700;letter-spacing:0.32em;color:var(--text-muted);text-transform:uppercase;margin-top:4px;}

/* Section heading */
.sb-label{font-size:0.5rem;font-weight:800;letter-spacing:0.32em;color:var(--text-muted);text-transform:uppercase;margin-bottom:10px;display:flex;align-items:center;gap:8px;}
.sb-label::after{content:'';flex:1;height:1px;background:var(--t15);}

/* Scrollable body */
.sb-body{padding:18px 16px 0;display:flex;flex-direction:column;gap:18px;flex:1;overflow-y:auto;}
.sb-body::-webkit-scrollbar{width:3px;}
.sb-body::-webkit-scrollbar-track{background:transparent;}
.sb-body::-webkit-scrollbar-thumb{background:var(--t20);border-radius:2px;}

/* Custom color card */
.sb-card-custom{margin-top:5px;border-style:dashed;border-color:var(--t25);}
.sb-card-custom:hover{border-style:solid;}
.sb-card-custom .sb-card-name::after{
  content:' ···';opacity:0.4;font-size:0.55rem;letter-spacing:0.05em;
}
.sb-card-custom.active{border-style:solid;}

/* ─── Discord SVG ─── */
#discordSvg path, #sidebarDiscordSvg path{fill:var(--text-muted);}
.sb-footer a{display:flex;align-items:center;gap:8px;text-decoration:none;opacity:0.5;transition:opacity 0.2s;}
.sb-footer a:hover{opacity:1;}

/* ─── THEME GRID - toggle-style rows ─── */
.sb-grid{display:flex;flex-direction:column;gap:5px;}

.sb-card{
  display:flex;align-items:center;gap:11px;
  padding:9px 12px;
  border-radius:8px;
  border:1px solid var(--subtle-border);
  background:var(--subtle-bg);
  cursor:pointer;
  transition:border-color 0.2s, background 0.2s, box-shadow 0.2s;
  position:relative;overflow:hidden;
}
.sb-card:hover{border-color:var(--t30);background:var(--t03);}
.sb-card.active{
  border-color:var(--t60a);
  background:var(--t08);
  box-shadow:0 0 0 1px var(--t15);
}
.sb-card:active{transform:scale(0.98);}

/* Color swatch block on left */
.sb-card-swatch{
  width:34px;height:22px;
  border-radius:4px;
  flex-shrink:0;
  box-shadow:0 1px 4px rgba(0,0,0,0.4), inset 0 1px 0 rgba(255,255,255,0.2);
  position:relative;overflow:hidden;
}
/* gloss shine on swatch */
.sb-card-swatch::after{
  content:'';position:absolute;
  top:0;left:0;right:0;height:45%;
  background:linear-gradient(180deg,rgba(255,255,255,0.3) 0%,rgba(255,255,255,0) 100%);
  border-radius:4px 4px 50% 50%;
}

/* Theme name */
.sb-card-name{
  font-size:0.65rem;font-weight:700;letter-spacing:0.1em;
  color:var(--text-secondary);text-transform:uppercase;flex:1;
  transition:color 0.2s;
}
.sb-card.active .sb-card-name{color:var(--t55);}

/* Feminine sparkle */
.sb-card-fem{
  font-size:0.6rem;color:var(--t40);flex-shrink:0;
}
.sb-card.active .sb-card-fem{color:var(--t60);}

/* Active dot indicator */
.sb-card-check{
  width:6px;height:6px;border-radius:50%;
  background:var(--t);flex-shrink:0;
  opacity:0;transform:scale(0);
  transition:opacity 0.2s,transform 0.2s;
}
.sb-card.active .sb-card-check{opacity:1;transform:scale(1);}

/* hide old */
.card-gem,.card-name,.card-fem{display:none !important;}

/* ─── MODE ROW ─── */
.sb-mode-row{
  display:flex;align-items:center;justify-content:space-between;
  background:var(--subtle-bg);border:1px solid var(--subtle-border);
  border-radius:10px;padding:12px 14px;cursor:pointer;transition:border-color 0.25s,background 0.25s;
}
.sb-mode-row:hover{border-color:var(--t30);background:var(--t03);}
.sb-mode-left{display:flex;align-items:center;gap:11px;}
.sb-mode-label{font-size:0.68rem;font-weight:700;letter-spacing:0.1em;color:var(--text-secondary);}

.sb-pill{width:44px;height:23px;background:var(--toggle-bg);border:1px solid var(--subtle-border);border-radius:12px;position:relative;transition:all 0.35s;flex-shrink:0;}
.sb-pill.on{background:var(--t20);border-color:var(--t50);}
.sb-pill::after{content:'';position:absolute;width:15px;height:15px;background:var(--toggle-knob);border-radius:50%;top:3px;left:3px;transition:all 0.35s;}
.sb-pill.on::after{transform:translateX(21px);background:var(--t60);}

/* ─── FOOTER ─── */
.sb-footer{padding:14px 16px 18px;border-top:1px solid rgba(255,255,255,0.04);display:flex;align-items:center;justify-content:center;}
body.light-mode .sb-footer{border-top-color:rgba(0,0,0,0.06);}
.sb-footer-txt{font-size:0.5rem;font-weight:700;letter-spacing:0.25em;color:var(--text-muted);text-transform:uppercase;}

/* ══════════════════════════════════════════════════════════
   NEW FEATURES CSS
   ══════════════════════════════════════════════════════════ */

/* Live Preview */
.live-preview-badge{position:absolute;top:12px;right:12px;background:hsla(var(--theme-hue),var(--theme-sat),50%,0.15);border:1px solid hsla(var(--theme-hue),var(--theme-sat),50%,0.3);border-radius:12px;padding:4px 10px;font-size:0.6rem;font-weight:700;letter-spacing:0.1em;color:hsl(var(--theme-hue),var(--theme-sat),55%);text-transform:uppercase;animation:fadeIn 0.3s;}

/* Gradient Library Panel */
.grad-lib-btn{position:fixed;bottom:24px;right:24px;width:56px;height:56px;background:linear-gradient(135deg,hsla(var(--theme-hue),var(--theme-sat),50%,0.2),hsla(var(--theme-hue),var(--theme-sat),45%,0.1));border:2px solid hsla(var(--theme-hue),var(--theme-sat),50%,0.4);border-radius:50%;display:flex;align-items:center;justify-content:center;cursor:pointer;z-index:900;transition:all 0.3s;box-shadow:0 4px 20px hsla(var(--theme-hue),var(--theme-sat),50%,0.3);}
.grad-lib-btn:hover{transform:scale(1.1);box-shadow:0 6px 30px hsla(var(--theme-hue),var(--theme-sat),50%,0.5);}
.grad-lib-btn svg{width:24px;height:24px;}

.grad-lib-panel{position:fixed;top:0;right:-400px;width:380px;max-width:90vw;height:100vh;background:var(--bg-card);border-left:1px solid var(--border-primary);z-index:1001;transition:right 0.4s cubic-bezier(0.4,0,0.2,1);overflow-y:auto;box-shadow:-10px 0 40px rgba(0,0,0,0.5);}
.grad-lib-panel.open{right:0;}
.grad-lib-header{position:sticky;top:0;background:var(--bg-card);border-bottom:1px solid var(--border-primary);padding:20px;z-index:10;}
.grad-lib-title{font-size:1.2rem;font-weight:800;letter-spacing:0.1em;color:var(--text-primary);text-transform:uppercase;margin-bottom:12px;}
.grad-lib-search{width:100%;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:4px;padding:10px 12px;color:var(--text-primary);font-size:0.85rem;}
.grad-lib-search:focus{outline:none;border-color:hsla(var(--theme-hue),var(--theme-sat),50%,0.4);}

.grad-lib-grid{display:grid;grid-template-columns:1fr;gap:12px;padding:20px;}
.grad-item{background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.08);border-radius:6px;padding:12px;cursor:pointer;transition:all 0.2s;}
.grad-item:hover{border-color:hsla(var(--theme-hue),var(--theme-sat),50%,0.4);transform:translateX(-4px);}
.grad-item-preview{height:60px;border-radius:4px;margin-bottom:10px;}
.grad-item-name{font-size:0.85rem;font-weight:700;color:var(--text-primary);margin-bottom:4px;}
.grad-item-colors{font-size:0.7rem;color:var(--text-secondary);font-family:monospace;}

/* History & Favorites Panel */
.history-panel{position:fixed;top:0;left:-400px;width:380px;max-width:90vw;height:100vh;background:var(--bg-card);border-right:1px solid var(--border-primary);z-index:1001;transition:left 0.4s cubic-bezier(0.4,0,0.2,1);overflow-y:auto;box-shadow:10px 0 40px rgba(0,0,0,0.5);}
.history-panel.open{left:0;}
.history-tabs{display:flex;border-bottom:1px solid var(--border-primary);}
.history-tab{flex:1;padding:16px;text-align:center;font-size:0.75rem;font-weight:700;letter-spacing:0.1em;text-transform:uppercase;color:var(--text-secondary);cursor:pointer;transition:all 0.2s;border-bottom:2px solid transparent;}
.history-tab.active{color:hsl(var(--theme-hue),var(--theme-sat),55%);border-bottom-color:hsl(var(--theme-hue),var(--theme-sat),55%);}
.history-content{padding:20px;}
.history-item{background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.06);border-radius:6px;padding:14px;margin-bottom:10px;cursor:pointer;transition:all 0.2s;}
.history-item:hover{border-color:hsla(var(--theme-hue),var(--theme-sat),50%,0.3);}
.history-item-text{font-size:0.9rem;color:var(--text-primary);margin-bottom:8px;word-break:break-all;}
.history-item-grad{height:4px;border-radius:2px;margin-bottom:8px;}
.history-item-meta{display:flex;justify-content:space-between;font-size:0.65rem;color:var(--text-muted);}
.history-empty{text-align:center;padding:40px 20px;color:var(--text-muted);font-size:0.85rem;}


/* Color Extraction */
.extract-zone{border:2px dashed rgba(255,255,255,0.2);border-radius:8px;padding:30px;text-align:center;cursor:pointer;transition:all 0.3s;position:relative;overflow:hidden;}
.extract-zone:hover{border-color:hsla(var(--theme-hue),var(--theme-sat),50%,0.4);background:rgba(255,255,255,0.02);}
.extract-zone.active{border-color:hsl(var(--theme-hue),var(--theme-sat),55%);background:hsla(var(--theme-hue),var(--theme-sat),50%,0.05);}
.extract-preview{width:100%;max-width:200px;height:120px;object-fit:cover;border-radius:6px;margin:12px auto;}
.extract-colors{display:flex;gap:8px;justify-content:center;margin-top:12px;}
.extract-color{width:40px;height:40px;border-radius:6px;cursor:pointer;transition:transform 0.2s;border:2px solid transparent;}
.extract-color:hover{transform:scale(1.1);border-color:rgba(255,255,255,0.3);}

/* Gradient Mixer */
.mixer-container{display:grid;grid-template-columns:1fr 80px 1fr;gap:16px;align-items:center;margin-bottom:20px;}
.mixer-grad{height:60px;border-radius:6px;border:2px solid rgba(255,255,255,0.1);cursor:pointer;transition:all 0.2s;}
.mixer-grad:hover{border-color:hsla(var(--theme-hue),var(--theme-sat),50%,0.3);}
.mixer-grad.selected{border-color:hsl(var(--theme-hue),var(--theme-sat),55%);}
.mixer-icon{font-size:1.5rem;text-align:center;color:var(--text-muted);}
.mixer-slider-wrap{margin-top:16px;}
.mixer-result{height:80px;border-radius:8px;margin-top:16px;border:2px solid hsla(var(--theme-hue),var(--theme-sat),50%,0.3);}

/* Animation Preview */
.anim-controls{display:flex;gap:8px;flex-wrap:wrap;margin-top:16px;}
.anim-btn{background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.08);border-radius:20px;padding:6px 14px;font-size:0.7rem;font-weight:600;color:var(--text-secondary);cursor:pointer;transition:all 0.2s;}
.anim-btn:hover{border-color:hsla(var(--theme-hue),var(--theme-sat),50%,0.3);color:var(--text-primary);}
.anim-btn.active{background:hsla(var(--theme-hue),var(--theme-sat),50%,0.15);border-color:hsla(var(--theme-hue),var(--theme-sat),50%,0.5);color:hsl(var(--theme-hue),var(--theme-sat),55%);}

/* Additional Animations */
@keyframes pulse{0%,100%{opacity:1;}50%{opacity:0.6;}}
@keyframes wave{0%,100%{background-position:0% 50%;}50%{background-position:100% 50%;}}
@keyframes glow{0%,100%{filter:brightness(1) saturate(1);}50%{filter:brightness(1.3) saturate(1.5);}}
@keyframes slide{0%{background-position:0% center;}100%{background-position:200% center;}}
@keyframes fadeIn{from{opacity:0;transform:translateY(10px);}to{opacity:1;transform:translateY(0);}}

/* Mobile Optimizations */
@media(max-width:768px){
  .grad-lib-panel,.history-panel{width:100vw;max-width:100vw;}
  .grad-lib-btn{bottom:80px;right:16px;width:50px;height:50px;}
  .mixer-container{grid-template-columns:1fr;gap:12px;}
  .mixer-icon{transform:rotate(90deg);}
}

/* Floating Action Buttons */
.fab-group{position:fixed;bottom:24px;left:24px;display:flex;flex-direction:column;gap:12px;z-index:900;}
.fab{width:48px;height:48px;border-radius:50%;background:var(--bg-card);border:1px solid var(--border-primary);display:flex;align-items:center;justify-content:center;cursor:pointer;transition:all 0.3s;box-shadow:0 4px 12px rgba(0,0,0,0.3);}
.fab:hover{transform:scale(1.1);border-color:hsla(var(--theme-hue),var(--theme-sat),50%,0.4);}
.fab svg{width:20px;height:20px;stroke:var(--text-primary);}

/* Shortcuts Panel */
.shortcuts-hint{position:fixed;bottom:24px;left:50%;transform:translateX(-50%);background:rgba(0,0,0,0.9);border:1px solid rgba(255,255,255,0.1);border-radius:6px;padding:8px 16px;font-size:0.75rem;color:rgba(255,255,255,0.7);opacity:0;pointer-events:none;transition:opacity 0.3s;z-index:1000;}
.shortcuts-hint.show{opacity:1;}
.kbd{display:inline-block;background:rgba(255,255,255,0.1);border:1px solid rgba(255,255,255,0.2);border-radius:3px;padding:2px 6px;font-family:monospace;font-size:0.7rem;margin:0 2px;}

</style>
</head>
<body>
<div class="premium-bg"></div>
<div class="luxury-grid"></div>
<div class="mouse-glow" id="mouseGlow"></div>

<!-- HAMBURGER -->
<div id="hamburgerBtn" onclick="openSidebar()">
  <span></span><span></span><span></span>
</div>

<!-- OVERLAY -->
<div id="sidebarOverlay" onclick="closeSidebar()"></div>

<!-- SIDEBAR -->
<div id="sidebarPanel">
  <div class="sb-header">
    <div class="sb-logo">HA-NASSIM ♔</div>
    <div class="sb-sub">Luxury Color Generator</div>
  </div>

  <div class="sb-body">

    <!-- THEMES -->
    <div>
      <div class="sb-label">Theme</div>
      <div class="sb-grid" id="themeGrid"></div>

      <!-- Custom color row -->
      <div class="sb-card sb-card-custom" id="tc-custom" onclick="triggerCustomPicker()">
        <div class="sb-card-swatch" id="customSwatch" style="background:linear-gradient(135deg,#ff6b6b,#a855f7,#3b82f6);"></div>
        <span class="sb-card-name">Custom</span>
        <div class="sb-card-check"></div>
        <input type="color" id="customColorInput" value="#a855f7"
          style="position:absolute;opacity:0;width:0;height:0;pointer-events:none;"
          oninput="onCustomColor(this.value)" onchange="onCustomColor(this.value)">
      </div>
    </div>

    <!-- MODE -->
    <div>
      <div class="sb-label">Appearance</div>
      <div class="sb-mode-row" onclick="toggleLightMode()">
        <div class="sb-mode-left">
          <div id="modeIconWrap">
            <!-- MOON (dark mode) -->
            <svg id="moonSvg" width="19" height="19" viewBox="0 0 24 24" fill="none">
              <path d="M21 12.79A9 9 0 1 1 11.21 3a7 7 0 0 0 9.79 9.79z"
                stroke="hsl(var(--theme-hue),var(--theme-sat),58%)"
                stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            <!-- SUN (light mode) -->
            <svg id="sunSvg" width="19" height="19" viewBox="0 0 24 24" fill="none" style="display:none;">
              <circle cx="12" cy="12" r="4.5" stroke="hsl(var(--theme-hue),var(--theme-sat),52%)" stroke-width="1.6"/>
              <line x1="12" y1="1.5" x2="12" y2="4.5" stroke="hsl(var(--theme-hue),var(--theme-sat),52%)" stroke-width="1.6" stroke-linecap="round"/>
              <line x1="12" y1="19.5" x2="12" y2="22.5" stroke="hsl(var(--theme-hue),var(--theme-sat),52%)" stroke-width="1.6" stroke-linecap="round"/>
              <line x1="1.5" y1="12" x2="4.5" y2="12" stroke="hsl(var(--theme-hue),var(--theme-sat),52%)" stroke-width="1.6" stroke-linecap="round"/>
              <line x1="19.5" y1="12" x2="22.5" y2="12" stroke="hsl(var(--theme-hue),var(--theme-sat),52%)" stroke-width="1.6" stroke-linecap="round"/>
              <line x1="3.87" y1="3.87" x2="5.99" y2="5.99" stroke="hsl(var(--theme-hue),var(--theme-sat),52%)" stroke-width="1.6" stroke-linecap="round"/>
              <line x1="18.01" y1="18.01" x2="20.13" y2="20.13" stroke="hsl(var(--theme-hue),var(--theme-sat),52%)" stroke-width="1.6" stroke-linecap="round"/>
              <line x1="20.13" y1="3.87" x2="18.01" y2="5.99" stroke="hsl(var(--theme-hue),var(--theme-sat),52%)" stroke-width="1.6" stroke-linecap="round"/>
              <line x1="5.99" y1="18.01" x2="3.87" y2="20.13" stroke="hsl(var(--theme-hue),var(--theme-sat),52%)" stroke-width="1.6" stroke-linecap="round"/>
            </svg>
          </div>
          <span class="sb-mode-label" id="modeLabel">Dark Mode</span>
        </div>
        <div class="sb-pill" id="modePill"></div>
      </div>
    </div>

  </div><!-- end sb-body -->

  <div class="sb-footer">
    <a href="https://discord.com/users/nassim915" target="_blank">
      <svg id="sidebarDiscordSvg" width="17" height="17" viewBox="0 0 24 24" fill="none">
        <path d="M20.317 4.37a19.791 19.791 0 0 0-4.885-1.515.074.074 0 0 0-.079.037c-.21.375-.444.864-.608 1.25a18.27 18.27 0 0 0-5.487 0 12.64 12.64 0 0 0-.617-1.25.077.077 0 0 0-.079-.037A19.736 19.736 0 0 0 3.677 4.37a.07.07 0 0 0-.032.027C.533 9.046-.32 13.58.099 18.057c.002.022.015.04.03.052a19.9 19.9 0 0 0 5.993 3.03.078.078 0 0 0 .084-.028c.462-.63.874-1.295 1.226-1.994a.076.076 0 0 0-.041-.106 13.107 13.107 0 0 1-1.872-.892.077.077 0 0 1-.008-.128 10.2 10.2 0 0 0 .372-.292.074.074 0 0 1 .077-.01c3.928 1.793 8.18 1.793 12.062 0a.074.074 0 0 1 .078.01c.12.098.246.198.373.292a.077.077 0 0 1-.006.127 12.299 12.299 0 0 1-1.873.892.077.077 0 0 0-.041.107c.36.698.772 1.362 1.225 1.993a.076.076 0 0 0 .084.028 19.839 19.839 0 0 0 6.002-3.03.077.077 0 0 0 .032-.054c.5-5.177-.838-9.674-3.549-13.66a.061.061 0 0 0-.031-.03z"/>
      </svg>
      <span class="sb-footer-txt">Discord · Nassim</span>
    </a>
  </div>
</div>

<!-- MAIN -->
<div style="position:relative;z-index:1;max-width:800px;margin:0 auto;padding:3rem 1.5rem 2rem;">

  <header style="text-align:center;margin-bottom:3.5rem;" class="fade-up">
    <div class="title-glow" id="titleGlow">HA-NASSIM &nbsp; ♔</div>
    <div style="height:1px;background:linear-gradient(90deg,transparent,var(--t40),transparent);margin:1.5rem auto;width:40%;"></div>
  </header>

  <div class="glass-card fade-up" style="padding:24px;margin-bottom:16px;animation-delay:0.1s;">
    <div class="section-label"><span>Input</span></div>
    <textarea id="textInput" rows="2" placeholder="Type your text here..."></textarea>
    <div style="display:flex;gap:8px;align-items:center;margin-top:12px;flex-wrap:wrap;">
      <span style="font-size:0.6rem;font-weight:700;letter-spacing:0.2em;color:var(--char-count);text-transform:uppercase;">Limit</span>
      <button class="pill-btn active" onclick="setLimit(128,this)">128</button>
      <button class="pill-btn" onclick="setLimit(238,this)">238</button>
      <span id="charCount" style="margin-left:auto;font-size:0.65rem;color:var(--char-count);">0 chars</span>
    </div>
  </div>

  <div class="glass-card fade-up" style="padding:24px;margin-bottom:16px;animation-delay:0.2s;">
    <div class="section-label"><span>Colors</span></div>
    <div class="preset-grid" id="presetsGrid"></div>
    <div class="grad-bar" id="gradBar"></div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:14px;">
      <div>
        <span class="field-label">Start</span>
        <div class="color-row">
          <input type="color" id="color1" value="#D4A017" oninput="syncHex(1)">
          <input class="hex-field" id="hex1" value="D4A017" maxlength="6" oninput="syncColor(1)">
        </div>
      </div>
      <div>
        <span class="field-label">End</span>
        <div class="color-row">
          <input type="color" id="color2" value="#7C3AED" oninput="syncHex(2)">
          <input class="hex-field" id="hex2" value="7C3AED" maxlength="6" oninput="syncColor(2)">
        </div>
      </div>
    </div>
    <div class="toggle-wrap" onclick="toggleThird()">
      <div class="toggle" id="thirdToggle"></div>
      <span class="toggle-text" style="letter-spacing:0.12em;">Add middle color</span>
    </div>
    <div class="toggle-wrap" onclick="toggleSingleColor()" style="margin-top:12px;">
      <div class="toggle" id="singleToggle"></div>
      <span class="toggle-text" style="letter-spacing:0.12em;">Single color mode</span>
    </div>
    <div id="thirdRow" style="display:none;margin-top:12px;">
      <span class="field-label">Middle</span>
      <div class="color-row">
        <input type="color" id="color3" value="#E879F9" oninput="syncHex(3)">
        <input class="hex-field" id="hex3" value="E879F9" maxlength="6" oninput="syncColor(3)">
      </div>
    </div>
  </div>

  <div class="glass-card fade-up" style="padding:24px;margin-bottom:16px;animation-delay:0.3s;">
    <div class="section-label"><span>Gradient Mode</span></div>
    <div class="mode-grid" style="margin-bottom:20px;">
      <div class="mode-card active" onclick="setMode('ltr',this)"><span class="mode-icon">→</span><span class="mode-text">Left → Right</span></div>
      <div class="mode-card" onclick="setMode('rtl',this)"><span class="mode-icon">←</span><span class="mode-text">Right → Left</span></div>
      <div class="mode-card" onclick="setMode('center-out',this)"><span class="mode-icon">◈</span><span class="mode-text">Center Light</span></div>
      <div class="mode-card" onclick="setMode('edges-in',this)"><span class="mode-icon">◉</span><span class="mode-text">Edges Light</span></div>
    </div>
    <div style="display:flex;align-items:center;gap:14px;">
      <span style="font-size:0.6rem;font-weight:700;letter-spacing:0.2em;color:var(--char-count);text-transform:uppercase;white-space:nowrap;">Steps</span>
      <input type="range" id="stepsRange" min="2" max="12" value="12" oninput="updateSteps()">
      <span id="stepsVal" style="font-size:0.8rem;font-weight:800;color:var(--t);min-width:20px;text-align:center;">12</span>
    </div>
  </div>

  <div id="genArea" style="margin-bottom:24px;animation-delay:0.4s;" class="fade-up">
    <button class="gen-btn" id="genBtn" onclick="handleGenClick()">✦ &nbsp; Generate &nbsp; ✦</button>
    <div id="passArea" style="display:none;position:relative;">
      <input type="password" id="passInput" placeholder="Enter password..." autocomplete="off"
        style="width:100%;background:var(--t03);border:1px solid var(--t30);border-radius:2px;padding:16px;color:#fff;font-family:'Inter',sans-serif;font-size:0.85rem;letter-spacing:0.2em;text-align:center;outline:none;"
        oninput="checkPass(this.value)">
      <span id="passHint" style="display:block;text-align:center;font-size:0.6rem;color:rgba(255,255,255,0.15);letter-spacing:0.2em;margin-top:8px;text-transform:uppercase;"></span>
    </div>
  </div>

  <div id="outputSection" style="display:none;">
    <div class="glass-card" style="padding:24px;margin-bottom:16px;">
      <div class="section-label"><span>Preview</span></div>
      <div class="preview-box" id="previewArea"></div>
      <button class="copy-all" onclick="copyAll()">⧉ &nbsp; Copy All Messages</button>
      <div id="msgsContainer"></div>
    </div>
  </div>

  <div style="text-align:center;padding:1.5rem 0 0;">
    <a href="https://discord.com/users/nassim915" target="_blank" style="display:inline-flex;flex-direction:column;align-items:center;gap:8px;text-decoration:none;transition:opacity 0.2s;" onmouseover="this.style.opacity='0.7'" onmouseout="this.style.opacity='1'">
      <svg id="discordSvg" width="28" height="28" viewBox="0 0 24 24" fill="none">
        <path d="M20.317 4.37a19.791 19.791 0 0 0-4.885-1.515.074.074 0 0 0-.079.037c-.21.375-.444.864-.608 1.25a18.27 18.27 0 0 0-5.487 0 12.64 12.64 0 0 0-.617-1.25.077.077 0 0 0-.079-.037A19.736 19.736 0 0 0 3.677 4.37a.07.07 0 0 0-.032.027C.533 9.046-.32 13.58.099 18.057c.002.022.015.04.03.052a19.9 19.9 0 0 0 5.993 3.03.078.078 0 0 0 .084-.028c.462-.63.874-1.295 1.226-1.994a.076.076 0 0 0-.041-.106 13.107 13.107 0 0 1-1.872-.892.077.077 0 0 1-.008-.128 10.2 10.2 0 0 0 .372-.292.074.074 0 0 1 .077-.01c3.928 1.793 8.18 1.793 12.062 0a.074.074 0 0 1 .078.01c.12.098.246.198.373.292a.077.077 0 0 1-.006.127 12.299 12.299 0 0 1-1.873.892.077.077 0 0 0-.041.107c.36.698.772 1.362 1.225 1.993a.076.076 0 0 0 .084.028 19.839 19.839 0 0 0 6.002-3.03.077.077 0 0 0 .032-.054c.5-5.177-.838-9.674-3.549-13.66a.061.061 0 0 0-.031-.03z"/>
      </svg>
      <span style="font-size:0.55rem;font-weight:700;letter-spacing:0.25em;color:var(--text-muted);text-transform:uppercase;">Discord</span>
    </a>
  </div>

  <footer style="text-align:center;padding:1rem 0 1rem;border-top:1px solid var(--subtle-border);margin-top:1rem;">
    <p style="font-size:0.6rem;font-weight:600;letter-spacing:0.3em;color:var(--text-muted);text-transform:uppercase;">Created by &nbsp;·&nbsp; Elhamdi Nassim</p>
  </footer>
</div>

<script>
/* ══════════════════════════════════
   LUXURY THEMES
══════════════════════════════════ */
const THEMES = [
  // ── Masculine Luxury ──
  {
    id:'royal-gold', name:'Royal Gold', feminine:false,
    hex:'#D4A017', h:43, s:82,
    title:'linear-gradient(135deg,#fff 0%,#D4A017 38%,#fbbf24 65%,#fff 100%)',
    gem:'linear-gradient(135deg, #FFF4A3 0%, #F5C842 15%, #C8960A 42%, #8A6200 72%, #3A2800 100%)'
  },
  {
    id:'platinum', name:'Platinum', feminine:false,
    hex:'#B8C2D0', h:215, s:18,
    title:'linear-gradient(135deg,#fff 0%,#B8C2D0 38%,#fbbf24 65%,#fff 100%)',
    gem:'linear-gradient(135deg, #FFFFFF 0%, #DEE8F5 18%, #AABACE 42%, #6A7A90 72%, #283848 100%)'
  },
  {
    id:'sapphire', name:'Sapphire', feminine:false,
    hex:'#2060D0', h:219, s:76,
    title:'linear-gradient(135deg,#fff 0%,#4A90FF 38%,#fbbf24 65%,#fff 100%)',
    gem:'linear-gradient(135deg, #B0D8FF 0%, #3878F0 22%, #0A38B8 50%, #041880 76%, #010830 100%)'
  },
  {
    id:'emerald', name:'Emerald', feminine:false,
    hex:'#197A46', h:148, s:62,
    title:'linear-gradient(135deg,#fff 0%,#28C870 38%,#fbbf24 65%,#fff 100%)',
    gem:'linear-gradient(135deg, #7AFFC0 0%, #18C860 22%, #087840 50%, #024018 76%, #001008 100%)'
  },
  {
    id:'amethyst', name:'Amethyst', feminine:false,
    hex:'#7235A0', h:282, s:48,
    title:'linear-gradient(135deg,#fff 0%,#A855F7 38%,#fbbf24 65%,#fff 100%)',
    gem:'linear-gradient(135deg, #ECC8FF 0%, #A848E8 22%, #6018B0 50%, #380878 76%, #160030 100%)'
  },
  {
    id:'ruby', name:'Ruby', feminine:false,
    hex:'#BE1A38', h:348, s:74,
    title:'linear-gradient(135deg,#fff 0%,#E8294A 38%,#fbbf24 65%,#fff 100%)',
    gem:'linear-gradient(135deg, #FFA0A8 0%, #E81838 22%, #980018 50%, #500008 76%, #1A0002 100%)'
  },
  // ── Feminine Luxury ──
  {
    id:'rose-gold', name:'Rose Gold', feminine:true,
    hex:'#C07050', h:19, s:46,
    title:'linear-gradient(135deg,#fff 0%,#E8A480 38%,#fbbf24 65%,#fff 100%)',
    gem:'linear-gradient(135deg, #FFE8D5 0%, #E8A070 22%, #B06838 50%, #783020 76%, #321008 100%)'
  },
  {
    id:'sakura', name:'Sakura', feminine:true,
    hex:'#D85882', h:340, s:62,
    title:'linear-gradient(135deg,#fff 0%,#F080AA 38%,#fbbf24 65%,#fff 100%)',
    gem:'linear-gradient(135deg, #FFD0E8 0%, #E85898 22%, #A01858 50%, #600030 76%, #220010 100%)'
  },
  {
    id:'lavender', name:'Lavender', feminine:true,
    hex:'#8A70CC', h:260, s:50,
    title:'linear-gradient(135deg,#fff 0%,#B09AEE 38%,#fbbf24 65%,#fff 100%)',
    gem:'linear-gradient(135deg, #EAD8FF 0%, #A878E8 22%, #6830B8 50%, #380878 76%, #140030 100%)'
  }
];

let currentThemeId = 'royal-gold';
let lightMode = false;
let charLimit=128, gradMode='ltr', useThird=false, useSingle=false, gradSteps=12, _unlocked=false;

/* ── Build theme grid ── */
function buildThemeGrid(){
  const grid = document.getElementById('themeGrid');
  grid.innerHTML = THEMES.map(t => `
    <div class="sb-card${t.id===currentThemeId?' active':''}"
         id="tc-${t.id}"
         onclick="applyTheme('${t.id}')"
         title="${t.name}">
      <div class="sb-card-swatch" style="background:${t.gem};"></div>
      <span class="sb-card-name">${t.name}</span>
      ${t.feminine ? `<span class="sb-card-fem">✦</span>` : ''}
      <div class="sb-card-check"></div>
    </div>
  `).join('');
}

/* ── Helper: HEX to HSL ── */
function hexToHSL(hex){
  hex = hex.replace('#','');
  const r = parseInt(hex.slice(0,2),16)/255;
  const g = parseInt(hex.slice(2,4),16)/255;
  const b = parseInt(hex.slice(4,6),16)/255;
  const max = Math.max(r,g,b), min = Math.min(r,g,b);
  let h, s, l = (max+min)/2;
  if(max===min){
    h=s=0;
  }else{
    const d = max-min;
    s = l>0.5 ? d/(2-max-min) : d/(max+min);
    switch(max){
      case r: h=((g-b)/d+(g<b?6:0))/6; break;
      case g: h=((b-r)/d+2)/6; break;
      case b: h=((r-g)/d+4)/6; break;
    }
  }
  return [Math.round(h*360), Math.round(s*100), Math.round(l*100)];
}

/* ── Custom color picker ── */
let _customHex = '#a855f7';

function triggerCustomPicker(){
  document.getElementById('customColorInput').click();
}

function onCustomColor(hex){
  _customHex = hex;
  // Update swatch to solid color
  document.getElementById('customSwatch').style.background = hex;
  // Mark active
  currentThemeId = 'custom';
  document.querySelectorAll('.sb-card').forEach(c => c.classList.remove('active'));
  document.getElementById('tc-custom').classList.add('active');
  // Apply as theme
  const [h,s,l] = hexToHSL(hex);
  document.documentElement.style.setProperty('--theme-hue', h);
  document.documentElement.style.setProperty('--theme-sat', s + '%');
  // Update title: custom color + gold
  const titleEl = document.getElementById('titleGlow');
  titleEl.style.backgroundImage = `linear-gradient(135deg,#fff 0%,${hex} 38%,#fbbf24 65%,#fff 100%)`;
  titleEl.style.backgroundSize = '200% auto';
  titleEl.style.webkitBackgroundClip = 'text';
  titleEl.style.backgroundClip = 'text';
  titleEl.style.webkitTextFillColor = 'transparent';
  // Update SVG icons
  const moonColor = `hsl(${h},${s}%,58%)`;
  const sunColor  = `hsl(${h},${s}%,52%)`;
  document.querySelectorAll('#moonSvg path').forEach(el => el.setAttribute('stroke', moonColor));
  document.querySelectorAll('#sunSvg circle,#sunSvg line').forEach(el => el.setAttribute('stroke', sunColor));
}

/* ── Apply theme ── */
function applyTheme(id){
  const t = THEMES.find(x => x.id === id);
  if(!t) return;
  currentThemeId = id;

  document.documentElement.style.setProperty('--theme-hue', t.h);
  document.documentElement.style.setProperty('--theme-sat', t.s + '%');

  // Update title
  const titleEl = document.getElementById('titleGlow');
  titleEl.style.backgroundImage = t.title;
  titleEl.style.backgroundSize = '200% auto';
  titleEl.style.webkitBackgroundClip = 'text';
  titleEl.style.backgroundClip = 'text';
  titleEl.style.webkitTextFillColor = 'transparent';

  // Update SVG strokes (force repaint)
  const moonColor = `hsl(${t.h},${t.s}%,58%)`;
  const sunColor  = `hsl(${t.h},${t.s}%,52%)`;
  document.querySelectorAll('#moonSvg path').forEach(el => el.setAttribute('stroke', moonColor));
  document.querySelectorAll('#sunSvg circle,#sunSvg line').forEach(el => el.setAttribute('stroke', sunColor));

  // Mark active
  document.querySelectorAll('.sb-card').forEach(c => c.classList.remove('active'));
  const card = document.getElementById('tc-' + id);
  if(card) card.classList.add('active');
}

/* ── Sidebar ── */
function openSidebar(){
  document.getElementById('sidebarPanel').classList.add('open');
  document.getElementById('sidebarOverlay').classList.add('open');
  document.getElementById('hamburgerBtn').classList.add('hidden');
}
function closeSidebar(){
  document.getElementById('sidebarPanel').classList.remove('open');
  document.getElementById('sidebarOverlay').classList.remove('open');
  document.getElementById('hamburgerBtn').classList.remove('hidden');
}

/* ── Light / Dark mode ── */
function toggleLightMode(){
  lightMode = !lightMode;
  document.body.classList.toggle('light-mode', lightMode);
  document.getElementById('modePill').classList.toggle('on', lightMode);
  document.getElementById('modeLabel').textContent = lightMode ? 'Light Mode' : 'Dark Mode';
  document.getElementById('moonSvg').style.display = lightMode ? 'none' : 'block';
  document.getElementById('sunSvg').style.display  = lightMode ? 'block' : 'none';
}

/* ── Mouse glow ── */
document.addEventListener('mousemove', e => {
  const t = THEMES.find(x => x.id === currentThemeId);
  if(!t) return;
  document.getElementById('mouseGlow').style.background =
    `radial-gradient(circle 500px at ${e.clientX}px ${e.clientY}px,hsla(${t.h},${t.s}%,50%,0.05),transparent 45%)`;
});

/* ── Generate ── */
function handleGenClick(){
  if(_unlocked){ generate(); return; }
  document.getElementById('genBtn').style.display='none';
  document.getElementById('passArea').style.display='block';
  setTimeout(()=>document.getElementById('passInput').focus(),50);
}
function checkPass(val){
  if(val==='nassim1'){
    _unlocked=true;
    document.getElementById('passArea').style.display='none';
    document.getElementById('genBtn').style.display='block';
    generate();
  }else if(val.length>=7){
    document.getElementById('passHint').textContent='✗  Invalid';
    document.getElementById('passInput').style.borderColor='rgba(255,70,70,0.8)';
    setTimeout(()=>{
      document.getElementById('passInput').value='';
      document.getElementById('passHint').textContent='';
      document.getElementById('passInput').style.borderColor='var(--t30)';
    },700);
  }
}

/* ── Presets ── */
const presets=[
  {c1:'FFE87C',c2:'8B5E00'},{c1:'E6D5F5',c2:'570F87'},
  {c1:'99D6E5',c2:'005777'},{c1:'FFE66D',c2:'DC143C'},
  {c1:'CCE6CC',c2:'003600'},{c1:'FFCDD2',c2:'801D1F'},
  {c1:'BA6BDF',c2:'0A1E3A'},{c1:'FFE0B2',c2:'8B3A00'},
];
function initPresets(){
  const g=document.getElementById('presetsGrid');
  g.innerHTML=presets.map((p,i)=>`<div class="preset-swatch" style="background:linear-gradient(90deg,#${p.c1},#${p.c2})" onclick="applyPreset(${i})"></div>`).join('');
}
function applyPreset(i){
  const p=presets[i];
  document.getElementById('color1').value='#'+p.c1;document.getElementById('hex1').value=p.c1;
  document.getElementById('color2').value='#'+p.c2;document.getElementById('hex2').value=p.c2;
  updateBar();
}

function setLimit(n,btn){ charLimit=n;document.querySelectorAll('.pill-btn').forEach(b=>b.classList.remove('active'));btn.classList.add('active');}
function setMode(m,btn){ gradMode=m;document.querySelectorAll('.mode-card').forEach(b=>b.classList.remove('active'));btn.classList.add('active');}
function updateSteps(){ gradSteps=parseInt(document.getElementById('stepsRange').value);document.getElementById('stepsVal').textContent=gradSteps;}

function syncHex(n){ const v=document.getElementById('color'+n).value;document.getElementById('hex'+n).value=v.substring(1).toUpperCase();updateBar();}
function syncColor(n){ const h=document.getElementById('hex'+n).value;if(h.length===6){document.getElementById('color'+n).value='#'+h;updateBar();}}

function toggleThird(){ useThird=!useThird;document.getElementById('thirdToggle').classList.toggle('on',useThird);document.getElementById('thirdRow').style.display=useThird?'block':'none';updateBar();}
function toggleSingleColor(){ useSingle=!useSingle;document.getElementById('singleToggle').classList.toggle('on',useSingle);updateBar();}

function updateBar(){
  const c1=document.getElementById('hex1').value,c2=document.getElementById('hex2').value,c3=document.getElementById('hex3').value;
  if(useSingle) document.getElementById('gradBar').style.background=`#${c1}`;
  else if(useThird) document.getElementById('gradBar').style.background=`linear-gradient(90deg,#${c1},#${c3},#${c2})`;
  else document.getElementById('gradBar').style.background=`linear-gradient(90deg,#${c1},#${c2})`;
}

function hexToRgb(h){return[parseInt(h.slice(0,2),16),parseInt(h.slice(2,4),16),parseInt(h.slice(4,6),16)];}
function lerp(a,b,t){return Math.round(a+(b-a)*t);}
function toHex(r,g,b){return[r,g,b].map(v=>v.toString(16).padStart(2,'0').toUpperCase()).join('');}

function getColors(steps){
  const c1=document.getElementById('hex1').value.toUpperCase(),c2=document.getElementById('hex2').value.toUpperCase();
  const c3=useThird?document.getElementById('hex3').value.toUpperCase():null;
  const out=[];
  if(c3){
    const h=Math.floor(steps/2);
    for(let i=0;i<=h;i++){const t=i/h;const[r1,g1,b1]=hexToRgb(c1);const[r3,g3,b3]=hexToRgb(c3);out.push(toHex(lerp(r1,r3,t),lerp(g1,g3,t),lerp(b1,b3,t)));}
    for(let i=1;i<steps-h;i++){const t=i/(steps-h-1||1);const[r3,g3,b3]=hexToRgb(c3);const[r2,g2,b2]=hexToRgb(c2);out.push(toHex(lerp(r3,r2,t),lerp(g3,g2,t),lerp(b3,b2,t)));}
  }else{
    for(let i=0;i<steps;i++){const t=i/(steps-1||1);const[r1,g1,b1]=hexToRgb(c1);const[r2,g2,b2]=hexToRgb(c2);out.push(toHex(lerp(r1,r2,t),lerp(g1,g2,t),lerp(b1,b2,t)));}
  }
  return out;
}

function applyMode(colors,mode){
  const n=colors.length;
  if(mode==='rtl') return[...colors].reverse();
  if(mode==='center-out'){const h=colors.slice(0,Math.ceil(n/2));const rv=[...h].reverse();return[...rv,...(n%2===0?h:h.slice(1))];}
  if(mode==='edges-in'){const h=colors.slice(0,Math.ceil(n/2));const rv=[...h].reverse();return[...h,...(n%2===0?rv:rv.slice(0,-1))];}
  return colors;
}

function renderPreview(code){return code.replace(/<c([0-9A-Fa-f]{6})>/g,'<span style="color:#$1">').replace(/<\/c>/g,'</span>');}
function escHtml(s){return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');}

function generate(){
  const text=document.getElementById('textInput').value.trim();
  if(!text) return;
  let code='';
  if(useSingle){
    code=`<c${document.getElementById('hex1').value.toUpperCase()}>${text}</c>`;
  }else{
    const colors=applyMode(getColors(gradSteps),gradMode);
    const available=charLimit-4;let bestColors=2;
    for(let n=2;n<=colors.length;n++){if(available-n*9>=text.length)bestColors=n;}
    const sel=[];
    for(let i=0;i<bestColors;i++) sel.push(colors[Math.round((i/(bestColors-1||1))*(colors.length-1))]);
    const cpp=Math.ceil(text.length/sel.length);let pos=0;
    sel.forEach(c=>{if(pos>=text.length)return;const chunk=text.substring(pos,Math.min(pos+cpp,text.length));code+=`<c${c}>${chunk}`;pos+=chunk.length;});
    code+='</c>';
  }
  window._msgs=[code];
  document.getElementById('previewArea').innerHTML=renderPreview(code);
  const con=document.getElementById('msgsContainer');con.innerHTML='';
  const d=document.createElement('div');d.className='msg-item';
  d.innerHTML=`<div class="msg-header"><span class="msg-num">${useSingle?'Single Color':'Single Message'}</span><span class="msg-chars">${code.length} / ${charLimit} chars</span></div><div class="msg-code">${escHtml(code)}</div>`;
  con.appendChild(d);
  document.getElementById('outputSection').style.display='block';
  document.getElementById('outputSection').scrollIntoView({behavior:'smooth'});
}

function copyAll(){
  const all=window._msgs.join('\n');
  navigator.clipboard.writeText(all).then(()=>{
    const btn=document.querySelector('.copy-all');btn.textContent='✓ All Copied';
    setTimeout(()=>{btn.innerHTML='⧉ &nbsp; Copy All Messages';},2000);
  }).catch(()=>{
    const ta=document.createElement('textarea');ta.value=all;ta.style.cssText='position:fixed;opacity:0;';
    document.body.appendChild(ta);ta.select();document.execCommand('copy');document.body.removeChild(ta);
    const btn=document.querySelector('.copy-all');btn.textContent='✓ All Copied';
    setTimeout(()=>{btn.innerHTML='⧉ &nbsp; Copy All Messages';},2000);
  });
}

document.getElementById('textInput').addEventListener('input',function(){
  document.getElementById('charCount').textContent=this.value.length+' chars';
});

/* ── Init ── */
buildThemeGrid();
applyTheme('royal-gold');
initPresets();
updateBar();

if('serviceWorker' in navigator) navigator.serviceWorker.register('sw.js');


/* ══════════════════════════════════════════════════════════
   GRADIENT LIBRARY - 50 Professional Gradients
   ══════════════════════════════════════════════════════════ */
const GRADIENT_LIBRARY = [
  {id:'fire',name:'Fire Storm',c1:'FF4E50',c2:'F9D423'},
  {id:'ocean',name:'Ocean Depth',c1:'2E3192',c2:'1BFFFF'},
  {id:'sunset',name:'Sunset Blaze',c1:'FF512F',c2:'F09819'},
  {id:'purple',name:'Purple Dream',c1:'c471f5',c2:'fa71cd'},
  {id:'mint',name:'Mint Fresh',c1:'00F260',c2:'0575E6'},
  {id:'rose',name:'Rose Gold',c1:'ED4264',c2:'FFEDBC'},
  {id:'cyber',name:'Cyberpunk',c1:'08AEEA',c2:'2AF598'},
  {id:'lava',name:'Lava Flow',c1:'C33764',c2:'1D2671'},
  {id:'emerald',name:'Emerald Night',c1:'348F50',c2:'56B4D3'},
  {id:'royal',name:'Royal Purple',c1:'360033',c2:'0b8793'},
  {id:'candy',name:'Cotton Candy',c1:'FFA8B6',c2:'B490FF'},
  {id:'neon',name:'Neon Life',c1:'B3FFAB',c2:'12FFF7'},
  {id:'blood',name:'Blood Moon',c1:'8E0E00',c2:'1F1C18'},
  {id:'ice',name:'Arctic Ice',c1:'E0EAFC',c2:'CFDEF3'},
  {id:'forest',name:'Forest Dawn',c1:'5A3F37',c2:'2C7744'},
  {id:'gold',name:'Golden Hour',c1:'FFE259',c2:'FFA751'},
  {id:'space',name:'Deep Space',c1:'000000',c2:'434343'},
  {id:'cherry',name:'Cherry Blossom',c1:'FBD3E9',c2:'BB377D'},
  {id:'volt',name:'High Voltage',c1:'FEF200',c2:'FF6B00'},
  {id:'toxic',name:'Toxic Waste',c1:'22C55E',c2:'581C87'},
  {id:'galaxy',name:'Galaxy Edge',c1:'654EA3',c2:'EAAFC8'},
  {id:'peach',name:'Peach Cream',c1:'FFE985',c2:'FA742B'},
  {id:'berry',name:'Wild Berry',c1:'8E2DE2',c2:'4A00E0'},
  {id:'coral',name:'Coral Reef',c1:'FF9A8B',c2:'FF6A88'},
  {id:'steel',name:'Cold Steel',c1:'485563',c2:'29323c'},
  {id:'amber',name:'Amber Glow',c1:'FF6F00',c2:'FFA000'},
  {id:'lavender',name:'Lavender Sky',c1:'DDD6F3',c2:'FAACA8'},
  {id:'lime',name:'Lime Light',c1:'A8E063',c2:'56AB2F'},
  {id:'ruby',name:'Ruby Red',c1:'9D50BB',c2:'6E48AA'},
  {id:'aqua',name:'Aqua Marine',c1:'1A2980',c2:'26D0CE'},
  {id:'bronze',name:'Bronze Age',c1:'C94B4B',c2:'4B134F'},
  {id:'pearl',name:'Pearl White',c1:'F3E5F5',c2:'E1BEE7'},
  {id:'jungle',name:'Jungle Green',c1:'0B486B',c2:'F56217'},
  {id:'noir',name:'Film Noir',c1:'434343',c2:'000000'},
  {id:'sand',name:'Desert Sand',c1:'EDC967',c2:'C89B3C'},
  {id:'sky',name:'Clear Sky',c1:'87CEEB',c2:'4682B4'},
  {id:'plum',name:'Dark Plum',c1:'4A148C',c2:'880E4F'},
  {id:'bronze2',name:'Warm Bronze',c1:'B7791F',c2:'D4AF37'},
  {id:'storm',name:'Thunder Storm',c1:'373B44',c2:'4286f4'},
  {id:'wine',name:'Red Wine',c1:'7F1734',c2:'C94B4B'},
  {id:'olive',name:'Olive Grove',c1:'50622E',c2:'9FA85D'},
  {id:'cobalt',name:'Cobalt Blue',c1:'0047AB',c2:'00BFFF'},
  {id:'autumn',name:'Autumn Leaves',c1:'D38312',c2:'A83279'},
  {id:'spring',name:'Spring Bloom',c1:'92FE9D',c2:'00C9FF'},
  {id:'winter',name:'Winter Frost',c1:'E6DADA',c2:'274046'},
  {id:'summer',name:'Summer Heat',c1:'FFD89B',c2:'19547B'},
  {id:'dawn',name:'Morning Dawn',c1:'F3904F',c2:'3B4371'},
  {id:'dusk',name:'Evening Dusk',c1:'2C3E50',c2:'FD746C'},
  {id:'midnight',name:'Midnight Blue',c1:'020024',c2:'090979'},
  {id:'blaze',name:'Phoenix Blaze',c1:'FF0099',c2:'493240'}
];

let gradLibOpen = false;

function openGradLib(){
  gradLibOpen = true;
  document.getElementById('gradLibPanel').classList.add('open');
  if(!document.getElementById('gradLibGrid').innerHTML){
    renderGradientLibrary();
  }
}

function closeGradLib(){
  gradLibOpen = false;
  document.getElementById('gradLibPanel').classList.remove('open');
}

function renderGradientLibrary(filter=''){
  const grid = document.getElementById('gradLibGrid');
  const filtered = filter ? 
    GRADIENT_LIBRARY.filter(g => g.name.toLowerCase().includes(filter.toLowerCase())) :
    GRADIENT_LIBRARY;
  
  grid.innerHTML = filtered.map(g => `
    <div class="grad-item" onclick="applyGradientFromLib('${g.c1}','${g.c2}')">
      <div class="grad-item-preview" style="background:linear-gradient(90deg,#${g.c1},#${g.c2})"></div>
      <div class="grad-item-name">${g.name}</div>
      <div class="grad-item-colors">#${g.c1} → #${g.c2}</div>
    </div>
  `).join('');
}

function searchGradients(query){
  renderGradientLibrary(query);
}

function applyGradientFromLib(c1, c2){
  document.getElementById('hex1').value = c1;
  document.getElementById('color1').value = '#' + c1;
  document.getElementById('hex2').value = c2;
  document.getElementById('color2').value = '#' + c2;
  updateBar();
  closeGradLib();
  showShortcutHint('Gradient applied! Press Ctrl+Enter to generate');
}

/* ══════════════════════════════════════════════════════════
   LIVE PREVIEW with Debouncing
   ══════════════════════════════════════════════════════════ */
let livePreviewTimeout;
let livePreviewEnabled = true;

function setupLivePreview(){
  const input = document.getElementById('textInput');
  input.addEventListener('input', () => {
    if(!livePreviewEnabled) return;
    clearTimeout(livePreviewTimeout);
    livePreviewTimeout = setTimeout(() => {
      if(input.value.trim()){
        generatePreview();
      }
    }, 400);
  });
}

function generatePreview(){
  // نفس منطق generate() لكن بدون عرض الرسائل
  const text = document.getElementById('textInput').value.trim();
  if(!text) return;
  
  let code = '';
  if(useSingle){
    const c1 = document.getElementById('hex1').value.toUpperCase();
    code = `<c${c1}>${text}</c>`;
  }else{
    const baseColors = getColors(gradSteps);
    const colors = applyMode(baseColors, gradMode);
    const available = charLimit - 4;
    let bestColors = 2;
    for(let n = 2; n <= colors.length; n++){
      const tagCost = n * 9;
      const spaceLeft = available - tagCost;
      if(spaceLeft >= text.length) bestColors = n;
    }
    const selectedColors = [];
    for(let i = 0; i < bestColors; i++){
      const idx = Math.round((i/(bestColors-1||1))*(colors.length-1));
      selectedColors.push(colors[idx]);
    }
    const charsPerColor = Math.ceil(text.length/selectedColors.length);
    let pos = 0;
    selectedColors.forEach(color => {
      if(pos >= text.length) return;
      const chunk = text.substring(pos, Math.min(pos+charsPerColor, text.length));
      code += `<c${color}>${chunk}`;
      pos += chunk.length;
    });
    code += '</c>';
  }
  
  // عرض في Preview
  const preview = document.getElementById('previewArea');
  if(preview){
    preview.innerHTML = renderPreview(code);
    // إضافة badge
    if(!preview.querySelector('.live-preview-badge')){
      const badge = document.createElement('div');
      badge.className = 'live-preview-badge';
      badge.textContent = 'Live';
      preview.parentElement.style.position = 'relative';
      preview.parentElement.insertBefore(badge, preview);
    }
  }
}

/* ══════════════════════════════════════════════════════════
   HISTORY & FAVORITES
   ══════════════════════════════════════════════════════════ */
let historyOpen = false;
let currentTab = 'history';

function openHistory(){
  historyOpen = true;
  document.getElementById('historyPanel').classList.add('open');
  loadHistory();
}

function closeHistory(){
  historyOpen = false;
  document.getElementById('historyPanel').classList.remove('open');
}

function switchHistoryTab(tab){
  currentTab = tab;
  document.getElementById('tabHistory').classList.toggle('active', tab === 'history');
  document.getElementById('tabFavorites').classList.toggle('active', tab === 'favorites');
  tab === 'history' ? loadHistory() : loadFavorites();
}

function loadHistory(){
  const history = JSON.parse(localStorage.getItem('ha_history') || '[]');
  const content = document.getElementById('historyContent');
  
  if(history.length === 0){
    content.innerHTML = '<div class="history-empty">No history yet. Start creating!</div>';
    return;
  }
  
  content.innerHTML = history.slice(0, 10).map((item, i) => `
    <div class="history-item" onclick="loadHistoryItem(${i})">
      <div class="history-item-text">${escHtml(item.text)}</div>
      <div class="history-item-grad" style="background:linear-gradient(90deg,#${item.c1},#${item.c2})"></div>
      <div class="history-item-meta">
        <span>${new Date(item.time).toLocaleDateString()}</span>
        <button onclick="event.stopPropagation();addToFavorites(${i})" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:1.2rem;">⭐</button>
      </div>
    </div>
  `).join('');
}

function loadFavorites(){
  const favorites = JSON.parse(localStorage.getItem('ha_favorites') || '[]');
  const content = document.getElementById('historyContent');
  
  if(favorites.length === 0){
    content.innerHTML = '<div class="history-empty">No favorites yet. Star your best gradients!</div>';
    return;
  }
  
  content.innerHTML = favorites.map((item, i) => `
    <div class="history-item" onclick="loadFavoriteItem(${i})">
      <div class="history-item-text">${escHtml(item.text)}</div>
      <div class="history-item-grad" style="background:linear-gradient(90deg,#${item.c1},#${item.c2})"></div>
      <div class="history-item-meta">
        <span>${item.name || 'Unnamed'}</span>
        <button onclick="event.stopPropagation();removeFromFavorites(${i})" style="background:none;border:none;color:gold;cursor:pointer;font-size:1.2rem;">★</button>
      </div>
    </div>
  `).join('');
}

function saveToHistory(text, c1, c2){
  const history = JSON.parse(localStorage.getItem('ha_history') || '[]');
  history.unshift({text, c1, c2, time: Date.now()});
  localStorage.setItem('ha_history', JSON.stringify(history.slice(0, 50)));
}

function loadHistoryItem(index){
  const history = JSON.parse(localStorage.getItem('ha_history') || '[]');
  const item = history[index];
  if(!item) return;
  
  document.getElementById('textInput').value = item.text;
  document.getElementById('hex1').value = item.c1;
  document.getElementById('color1').value = '#' + item.c1;
  document.getElementById('hex2').value = item.c2;
  document.getElementById('color2').value = '#' + item.c2;
  updateBar();
  closeHistory();
}

function addToFavorites(historyIndex){
  const history = JSON.parse(localStorage.getItem('ha_history') || '[]');
  const item = history[historyIndex];
  if(!item) return;
  
  const favorites = JSON.parse(localStorage.getItem('ha_favorites') || '[]');
  favorites.unshift(item);
  localStorage.setItem('ha_favorites', JSON.stringify(favorites.slice(0, 20)));
  showShortcutHint('Added to favorites!');
}

function loadFavoriteItem(index){
  const favorites = JSON.parse(localStorage.getItem('ha_favorites') || '[]');
  const item = favorites[index];
  if(!item) return;
  
  document.getElementById('textInput').value = item.text;
  document.getElementById('hex1').value = item.c1;
  document.getElementById('color1').value = '#' + item.c1;
  document.getElementById('hex2').value = item.c2;
  document.getElementById('color2').value = '#' + item.c2;
  updateBar();
  closeHistory();
}

function removeFromFavorites(index){
  const favorites = JSON.parse(localStorage.getItem('ha_favorites') || '[]');
  favorites.splice(index, 1);
  localStorage.setItem('ha_favorites', JSON.stringify(favorites));
  loadFavorites();
}

/* ══════════════════════════════════════════════════════════
   RANDOM GRADIENT GENERATOR
   ══════════════════════════════════════════════════════════ */
function randomGradient(){
  const grad = GRADIENT_LIBRARY[Math.floor(Math.random() * GRADIENT_LIBRARY.length)];
  document.getElementById('hex1').value = grad.c1;
  document.getElementById('color1').value = '#' + grad.c1;
  document.getElementById('hex2').value = grad.c2;
  document.getElementById('color2').value = '#' + grad.c2;
  updateBar();
  showShortcutHint(`Random: ${grad.name}`);
}

/* ══════════════════════════════════════════════════════════
   AI SUGGESTIONS (Rule-based)
   ══════════════════════════════════════════════════════════ */
const AI_KEYWORDS = {
  fire:['fire','flame','hot','burn','lava'],
  ice:['ice','cold','freeze','snow','winter'],
  ocean:['ocean','sea','water','wave'],
  sunset:['sunset','orange','evening'],
  toxic:['toxic','poison','acid','neon'],
  royal:['royal','king','queen','crown']
};

function getAISuggestion(text){
  text = text.toLowerCase();
  for(let [theme, keywords] of Object.entries(AI_KEYWORDS)){
    if(keywords.some(k => text.includes(k))){
      const grad = GRADIENT_LIBRARY.find(g => g.id === theme);
      if(grad) return grad;
    }
  }
  return null;
}

function applyAISuggestion(){
  const text = document.getElementById('textInput').value;
  const suggestion = getAISuggestion(text);
  if(suggestion){
    applyGradientFromLib(suggestion.c1, suggestion.c2);
    showShortcutHint(`AI Suggestion: ${suggestion.name}`);
  }
}

/* ══════════════════════════════════════════════════════════
   KEYBOARD SHORTCUTS
   ══════════════════════════════════════════════════════════ */
function setupKeyboardShortcuts(){
  document.addEventListener('keydown', e => {
    if(e.ctrlKey || e.metaKey){
      switch(e.key.toLowerCase()){
        case 'enter':
          e.preventDefault();
          if(_unlocked) generate();
          else handleGenClick();
          break;
        case 'r':
          e.preventDefault();
          randomGradient();
          break;
        case 'h':
          e.preventDefault();
          historyOpen ? closeHistory() : openHistory();
          break;
        case 'l':
          e.preventDefault();
          gradLibOpen ? closeGradLib() : openGradLib();
          break;
        case 'k':
          e.preventDefault();
          showShortcutHint('Ctrl+Enter: Generate | Ctrl+R: Random | Ctrl+H: History | Ctrl+L: Library', 3000);
          break;
      }
    }
  });
}

function showShortcutHint(text, duration = 2000){
  const hint = document.getElementById('shortcutsHint');
  hint.innerHTML = text;
  hint.classList.add('show');
  setTimeout(() => hint.classList.remove('show'), duration);
}


/* ══════════════════════════════════════════════════════════
   INITIALIZATION
   ══════════════════════════════════════════════════════════ */
function initFeatures(){
  setupLivePreview();
  setupKeyboardShortcuts();
}

// Override original generate to add history
const originalGenerate = window.generate;
window.generate = function(){
  originalGenerate.apply(this, arguments);
  const text = document.getElementById('textInput').value.trim();
  const c1 = document.getElementById('hex1').value;
  const c2 = document.getElementById('hex2').value;
  if(text) saveToHistory(text, c1, c2);
};


// Initialize all features
initFeatures();


/* ══════════════════════════════════════════════════════════
   COLOR EXTRACTION FROM IMAGE
   ══════════════════════════════════════════════════════════ */
function initColorExtraction(){
  // Add to settings panel
  const settingsPanel = document.getElementById('settingsPanel');
  if(!settingsPanel) return;
  
  const extractHTML = `
    <div class="panel-item">
      <div class="panel-label">Color Extraction</div>
      <div class="extract-zone" id="extractZone" onclick="document.getElementById('imageUpload').click()">
        <div id="extractContent">
          <div style="font-size:2rem;margin-bottom:8px;">🖼️</div>
          <div style="font-size:0.85rem;color:var(--text-primary);margin-bottom:4px;">Upload Image</div>
          <div style="font-size:0.7rem;color:var(--text-muted);">Extract colors from any image</div>
        </div>
      </div>
      <input type="file" id="imageUpload" accept="image/*" style="display:none;" onchange="extractColors(this)">
    </div>
  `;
  
  settingsPanel.insertAdjacentHTML('beforeend', extractHTML);
}

function extractColors(input){
  const file = input.files[0];
  if(!file) return;
  
  const reader = new FileReader();
  reader.onload = function(e){
    const img = new Image();
    img.onload = function(){
      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d');
      
      // Resize للأداء
      const maxSize = 200;
      const scale = Math.min(maxSize / img.width, maxSize / img.height);
      canvas.width = img.width * scale;
      canvas.height = img.height * scale;
      
      ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
      const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
      
      // استخراج ألوان مميزة
      const colors = getDistinctColors(imageData.data);
      displayExtractedColors(e.target.result, colors);
    };
    img.src = e.target.result;
  };
  reader.readAsDataURL(file);
}

function getDistinctColors(pixels){
  const colorMap = {};
  
  // Sample pixels
  for(let i = 0; i < pixels.length; i += 40){
    const r = pixels[i];
    const g = pixels[i + 1];
    const b = pixels[i + 2];
    
    // Skip very dark/light
    const brightness = (r + g + b) / 3;
    if(brightness < 30 || brightness > 240) continue;
    
    const hex = rgbToHex(r, g, b);
    colorMap[hex] = (colorMap[hex] || 0) + 1;
  }
  
  // Get top 5 colors
  return Object.entries(colorMap)
    .sort((a, b) => b[1] - a[1])
    .slice(0, 5)
    .map(([hex]) => hex);
}

function rgbToHex(r, g, b){
  return [r, g, b].map(v => v.toString(16).padStart(2, '0')).join('').toUpperCase();
}

function displayExtractedColors(imgSrc, colors){
  const zone = document.getElementById('extractZone');
  zone.classList.add('active');
  
  zone.innerHTML = `
    <img src="${imgSrc}" class="extract-preview">
    <div class="extract-colors">
      ${colors.map(c => `<div class="extract-color" style="background:#${c}" onclick="applyExtractedColor('${c}')" title="#${c}"></div>`).join('')}
    </div>
  `;
}

function applyExtractedColor(hex){
  if(!document.getElementById('hex2').value || confirm('Apply as end color?')){
    document.getElementById('hex2').value = hex;
    document.getElementById('color2').value = '#' + hex;
  }else{
    document.getElementById('hex1').value = hex;
    document.getElementById('color1').value = '#' + hex;
  }
  updateBar();
  showShortcutHint('Color applied!');
}

/* ══════════════════════════════════════════════════════════
   GRADIENT MIXER
   ══════════════════════════════════════════════════════════ */
function initGradientMixer(){
  const settingsPanel = document.getElementById('settingsPanel');
  if(!settingsPanel) return;
  
  const mixerHTML = `
    <div class="panel-item">
      <div class="panel-label">Gradient Mixer</div>
      <div class="mixer-container">
        <div class="mixer-grad" id="mixerGrad1" onclick="selectMixerGrad(1)" style="background:linear-gradient(90deg,#FF6B6B,#FFE66D)"></div>
        <div class="mixer-icon">+</div>
        <div class="mixer-grad" id="mixerGrad2" onclick="selectMixerGrad(2)" style="background:linear-gradient(90deg,#4ECDC4,#556270)"></div>
      </div>
      <div class="mixer-slider-wrap">
        <input type="range" id="mixerSlider" min="0" max="100" value="50" style="width:100%;" oninput="updateMixer()">
        <div style="display:flex;justify-content:space-between;font-size:0.7rem;color:var(--text-muted);margin-top:4px;">
          <span>100% A</span>
          <span id="mixerPercent">50%</span>
          <span>100% B</span>
        </div>
      </div>
      <div class="mixer-result" id="mixerResult"></div>
      <button class="tutorial-btn" onclick="applyMixedGradient()" style="width:100%;margin-top:12px;">Apply Mixed Gradient</button>
    </div>
  `;
  
  settingsPanel.insertAdjacentHTML('beforeend', mixerHTML);
}

let mixerGrad1 = {c1:'FF6B6B', c2:'FFE66D'};
let mixerGrad2 = {c1:'4ECDC4', c2:'556270'};
let mixerSelected = null;

function selectMixerGrad(num){
  mixerSelected = num;
  document.getElementById('mixerGrad1').classList.toggle('selected', num === 1);
  document.getElementById('mixerGrad2').classList.toggle('selected', num === 2);
  
  // Apply current colors
  const c1 = document.getElementById('hex1').value;
  const c2 = document.getElementById('hex2').value;
  if(num === 1){
    mixerGrad1 = {c1, c2};
    document.getElementById('mixerGrad1').style.background = `linear-gradient(90deg,#${c1},#${c2})`;
  }else{
    mixerGrad2 = {c1, c2};
    document.getElementById('mixerGrad2').style.background = `linear-gradient(90deg,#${c1},#${c2})`;
  }
  updateMixer();
}

function updateMixer(){
  const percent = document.getElementById('mixerSlider').value;
  document.getElementById('mixerPercent').textContent = percent + '%';
  
  const t = percent / 100;
  const mixed1 = blendHex(mixerGrad1.c1, mixerGrad2.c1, t);
  const mixed2 = blendHex(mixerGrad1.c2, mixerGrad2.c2, t);
  
  document.getElementById('mixerResult').style.background = 
    `linear-gradient(90deg,#${mixed1},#${mixed2})`;
}

function blendHex(hex1, hex2, t){
  const r1 = parseInt(hex1.slice(0,2), 16);
  const g1 = parseInt(hex1.slice(2,4), 16);
  const b1 = parseInt(hex1.slice(4,6), 16);
  const r2 = parseInt(hex2.slice(0,2), 16);
  const g2 = parseInt(hex2.slice(2,4), 16);
  const b2 = parseInt(hex2.slice(4,6), 16);
  
  const r = Math.round(r1 + (r2 - r1) * t);
  const g = Math.round(g1 + (g2 - g1) * t);
  const b = Math.round(b1 + (b2 - b1) * t);
  
  return [r,g,b].map(v => v.toString(16).padStart(2,'0')).join('').toUpperCase();
}

function applyMixedGradient(){
  const percent = document.getElementById('mixerSlider').value;
  const t = percent / 100;
  const c1 = blendHex(mixerGrad1.c1, mixerGrad2.c1, t);
  const c2 = blendHex(mixerGrad1.c2, mixerGrad2.c2, t);
  
  document.getElementById('hex1').value = c1;
  document.getElementById('color1').value = '#' + c1;
  document.getElementById('hex2').value = c2;
  document.getElementById('color2').value = '#' + c2;
  updateBar();
  showShortcutHint('Mixed gradient applied!');
}

/* ══════════════════════════════════════════════════════════
   ANIMATION PREVIEW
   ══════════════════════════════════════════════════════════ */
const ANIMATIONS = [
  {id:'none',name:'None',css:''},
  {id:'shimmer',name:'Shimmer',css:'shimmer 3s linear infinite'},
  {id:'pulse',name:'Pulse',css:'pulse 2s ease-in-out infinite'},
  {id:'wave',name:'Wave',css:'wave 4s ease-in-out infinite'},
  {id:'glow',name:'Glow',css:'glow 2s ease-in-out infinite'}
];

function initAnimationPreview(){
  const outputSection = document.getElementById('outputSection');
  if(!outputSection) return;
  
  // Add animation controls to preview
  const observer = new MutationObserver(() => {
    const preview = document.getElementById('previewArea');
    if(preview && !preview.nextElementSibling?.classList.contains('anim-controls')){
      addAnimationControls(preview);
    }
  });
  
  observer.observe(outputSection, {childList: true, subtree: true});
}

function addAnimationControls(preview){
  const controls = document.createElement('div');
  controls.className = 'anim-controls';
  controls.innerHTML = ANIMATIONS.map(a => 
    `<button class="anim-btn ${a.id === 'none' ? 'active' : ''}" onclick="applyAnimation('${a.id}', '${a.css}')" data-anim="${a.id}">${a.name}</button>`
  ).join('');
  
  preview.parentElement.insertBefore(controls, preview.nextSibling);
}

function applyAnimation(id, css){
  const preview = document.getElementById('previewArea');
  if(!preview) return;
  
  // Remove all animation classes
  preview.style.animation = css;
  preview.style.backgroundSize = css.includes('wave') || css.includes('slide') ? '200% auto' : '';
  
  // Update buttons
  document.querySelectorAll('.anim-btn').forEach(btn => {
    btn.classList.toggle('active', btn.dataset.anim === id);
  });
}

/* ══════════════════════════════════════════════════════════
   MOBILE TOUCH GESTURES
   ══════════════════════════════════════════════════════════ */
function initMobileOptimizations(){
  let touchStartX = 0;
  let touchEndX = 0;
  
  document.addEventListener('touchstart', e => {
    touchStartX = e.changedTouches[0].screenX;
  });
  
  document.addEventListener('touchend', e => {
    touchEndX = e.changedTouches[0].screenX;
    handleSwipe();
  });
  
  function handleSwipe(){
    const diff = touchStartX - touchEndX;
    
    // Swipe left to open library
    if(diff > 100 && !gradLibOpen && !historyOpen){
      openGradLib();
    }
    // Swipe right to open history
    else if(diff < -100 && !gradLibOpen && !historyOpen){
      openHistory();
    }
  }
}

/* ══════════════════════════════════════════════════════════
   INITIALIZE ADVANCED FEATURES
   ══════════════════════════════════════════════════════════ */
function initAdvancedFeatures(){
  initColorExtraction();
  initGradientMixer();
  initAnimationPreview();
  initMobileOptimizations();
}

// Auto-init when DOM ready
if(document.readyState === 'loading'){
  document.addEventListener('DOMContentLoaded', initAdvancedFeatures);
}else{
  initAdvancedFeatures();
}

</script>

<!-- ══════════════════════════════════════════════════════════
     GRADIENT LIBRARY PANEL
     ══════════════════════════════════════════════════════════ -->
<div class="grad-lib-panel" id="gradLibPanel">
  <div class="grad-lib-header">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
      <div class="grad-lib-title">Gradient Library</div>
      <button onclick="closeGradLib()" style="background:none;border:none;color:var(--text-secondary);font-size:1.5rem;cursor:pointer;padding:0;">×</button>
    </div>
    <input type="text" class="grad-lib-search" id="gradLibSearch" placeholder="Search gradients..." oninput="searchGradients(this.value)">
  </div>
  <div class="grad-lib-grid" id="gradLibGrid"></div>
</div>

<button class="grad-lib-btn" onclick="openGradLib()" title="Gradient Library">
  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
    <rect x="3" y="3" width="7" height="7" rx="1"/>
    <rect x="14" y="3" width="7" height="7" rx="1"/>
    <rect x="3" y="14" width="7" height="7" rx="1"/>
    <rect x="14" y="14" width="7" height="7" rx="1"/>
  </svg>
</button>

<!-- ══════════════════════════════════════════════════════════
     HISTORY & FAVORITES PANEL
     ══════════════════════════════════════════════════════════ -->
<div class="history-panel" id="historyPanel">
  <div class="history-tabs">
    <div class="history-tab active" onclick="switchHistoryTab('history')" id="tabHistory">History</div>
    <div class="history-tab" onclick="switchHistoryTab('favorites')" id="tabFavorites">Favorites</div>
  </div>
  <div style="padding:16px;border-bottom:1px solid var(--border-primary);">
    <button onclick="closeHistory()" style="width:100%;background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.08);border-radius:4px;padding:10px;color:var(--text-primary);font-size:0.75rem;font-weight:700;cursor:pointer;">Close</button>
  </div>
  <div class="history-content" id="historyContent"></div>
</div>

<div class="fab-group">
  <button class="fab" onclick="openHistory()" title="History & Favorites">
    <svg viewBox="0 0 24 24" fill="none" stroke-width="2">
      <circle cx="12" cy="12" r="10"/>
      <polyline points="12 6 12 12 16 14"/>
    </svg>
  </button>
  <button class="fab" onclick="randomGradient()" title="Random Gradient (Ctrl+R)">
    <svg viewBox="0 0 24 24" fill="none" stroke-width="2">
      <path d="M21 12h-8m0 0V4m0 8l7-7M3 12h8m0 0v8m0-8l-7 7"/>
    </svg>
  </button>
</div>

<!-- Keyboard Shortcuts Hint -->
<div class="shortcuts-hint" id="shortcutsHint"></div>

</body>
</html>
